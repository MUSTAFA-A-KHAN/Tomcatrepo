name: Install Tomcat on Windows

on:
  push:
    branches:
      - main

jobs:
  install-tomcat:
    runs-on: windows-latest

    env:
      CATALINA_HOME: ${{ env.SYSTEM_DEFAULTWORKINGDIRECTORY }}\a\Tomcatrepo\Tomcatrepo\Tomcat\apache-tomcat-10.0.14

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v2

      - name: Set up Chocolatey environment (if needed)
        run: |
          Import-Module $env:ChocolateyInstall\helpers\chocolateyProfile.psm1

      - name: Download and Install Tomcat
        run: |
          # Download and install Tomcat
          Invoke-WebRequest -Uri 'https://archive.apache.org/dist/tomcat/tomcat-10/v10.0.14/bin/apache-tomcat-10.0.14.zip' -OutFile 'tomcat.zip'
          Expand-Archive -Path 'tomcat.zip' -DestinationPath $env:CATALINA_HOME -Force
          Remove-Item -Path 'tomcat.zip' -Force

          # Add Tomcat bin directory to PATH
          $env:Path = $env:Path + ";$env:CATALINA_HOME\bin"

      - name: Debug Info
        run: |
          Get-ChildItem Env:
          Get-ChildItem $env:CATALINA_HOME -Recurse

      - name: Start Tomcat
        run: |
          Start-Process "$env:CATALINA_HOME\bin\startup.bat" -NoNewWindow
          Start-Sleep -Seconds 10

      - name: Wait for Tomcat to start
        run: |
          $url = 'http://localhost:8080/'
          $maxAttempts = 30
          $attempts = 0

          # Wait for Tomcat to start by checking if it responds to HTTP requests
          while ($attempts -lt $maxAttempts) {
              try {
                  Invoke-WebRequest -Uri $url -UseBasicParsing -TimeoutSec 5
                  Write-Host "Tomcat has started successfully."
                  break
              } catch {
                  Write-Host "Waiting for Tomcat to start. Attempt $($attempts + 1) of $maxAttempts..."
                  Start-Sleep -Seconds 10
                  $attempts++
              }
          }

          if ($attempts -ge $maxAttempts) {
              throw "Timed out waiting for Tomcat to start."
          }

      - name: Start ngrok and expose Tomcat port
        run: |
          # Start ngrok and expose Tomcat port
          Invoke-WebRequest 'https://bin.equinox.io/c/4VmDzA7iaHb/ngrok-stable-windows-amd64.zip' -OutFile 'ngrok-stable-windows-amd64.zip'
          Expand-Archive -Path '.\ngrok-stable-windows-amd64.zip' -DestinationPath '.\'
          java -version
          .\ngrok authtoken 1x4H0neaMfnRX0ATJsuLhMP3lt3_tEj68PPQBGSMmY8wZMHH
          .\ngrok.exe http 8080  # Change 8080 to the Tomcat port you want to expose
